<!-- DashboardComponent.html - ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå -->

<!-- Debug Log ‡πÅ‡∏£‡∏Å -->
<script>
    console.log('üé¨ [COMPONENT] DashboardComponent.html ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î...');
</script>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á My Work Overview -->
<div class="work-table-container">
    <table class="work-overview-table">
        <thead>
            <tr>
                <th></th>
                <th>‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</th>
                <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                <th>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</th>
                <th>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</th>
            </tr>
        </thead>
        <tbody>
            <tr>
               <td class="work-type-label">R</td>
              <td class="work-value">-</td>
              <td class="work-value clickable" onclick="showTab('prepare', 'R')" id="prepare-r">-</td>
              <td class="work-value clickable" onclick="showTab('prepare', 'R')" id="recorded-r">-</td>
              <td class="work-value clickable" onclick="showTab('backlog', 'R')" id="backlog-r">-</td>
              <td class="work-value clickable" onclick="showTab('return', 'R')" id="return-r">-</td>
          </tr>
            <tr>
              <td class="work-type-label">EMS</td>
              <td class="work-value">-</td>
              <td class="work-value clickable" onclick="showTab('prepare', 'EMS')" id="prepare-ems">-</td>
              <td class="work-value clickable" onclick="showTab('prepare', 'EMS')" id="recorded-ems">-</td>
              <td class="work-value clickable" onclick="showTab('backlog', 'EMS')" id="backlog-ems">-</td>
              <td class="work-value clickable" onclick="showTab('return', 'EMS')" id="return-ems">-</td>
          </tr>
           <tr>
              <td class="work-type-label">COD</td>
              <td class="work-value clickable" onclick="showTab('sendMoney', 'COD')" id="sendmoney-cod">-</td>
              <td class="work-value clickable" onclick="showTab('prepare', 'COD')" id="prepare-cod">-</td>
              <td class="work-value clickable" onclick="showTab('prepare', 'COD')" id="recorded-cod">-</td>
              <td class="work-value clickable" onclick="showTab('backlog', 'COD')" id="backlog-cod">-</td>
              <td class="work-value clickable" onclick="showTab('return', 'COD')" id="return-cod">-</td>
          </tr>
            <tr class="total-row">
              <td class="work-type-label">üì¶ ‡∏£‡∏ß‡∏°</td>
              <td class="work-total" id="total-sendmoney">-</td>
              <td class="work-total clickable" onclick="showTab('prepare', 'ALL')" id="total-prepare">-</td>
              <td class="work-total clickable" onclick="showTab('prepare', 'ALL')" id="total-recorded">-</td>
              <td class="work-total clickable" onclick="showTab('backlog', 'ALL')" id="total-backlog">-</td>
              <td class="work-total clickable" onclick="showTab('return', 'ALL')" id="total-return">-</td>
          </tr>
        </tbody>
    </table>
</div>

<!-- 4 Tabs -->
<div id="tabsContainer" style="display: none; margin-top: 30px;">
    <div class="tabs-header">
        <div class="tab active" data-tab="sendMoney" onclick="switchTab('sendMoney')">‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div class="tab" data-tab="prepare" onclick="switchTab('prepare')">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div class="tab" data-tab="backlog" onclick="switchTab('backlog')">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</div>
        <div class="tab" data-tab="return" onclick="switchTab('return')">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</div>
    </div>
    
    <div class="tabs-content">
        <div id="tabContent"></div>
    </div>
</div>

<!-- CSS -->
<style>
    .work-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .work-overview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 16px;
    }
    
    .work-overview-table thead {
        background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
        color: white;
    }
    
    .work-overview-table th {
        padding: 15px;
        text-align: center;
        font-weight: 600;
    }
    
    .work-overview-table td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .work-type-label {
        font-weight: 700;
        color: #333;
        text-align: left !important;
        padding-left: 30px !important;
    }
    
    .work-value {
        font-size: 18px;
        font-weight: 600;
        color: #666;
    }
    
    .work-value.clickable {
        color: #1976d2;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .work-value.clickable:hover {
        color: #d32f2f;
        transform: scale(1.1);
    }
    
    .total-row {
        background: #f8f9fa;
        border-top: 2px solid #37474f;
    }
    
    .work-total {
        font-size: 20px;
        font-weight: 700;
        color: #d32f2f;
    }
    
    .tabs-header {
        display: flex;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
        overflow: hidden;
    }
    
    .tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
    }
    
    .tab:hover {
        background: #e9ecef;
    }
    
    .tab.active {
        background: white;
        color: #d32f2f;
        border-bottom-color: #d32f2f;
    }
    
    .tabs-content {
        background: white;
        padding: 30px;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 400px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #d32f2f;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .stats-grid {
        display: flex;
        justify-content: space-around;
        gap: 15px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-left: 4px solid #ddd;
        min-width: 100px;
        flex: 1;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .stat-card.clickable {
        cursor: pointer;
    }
    
    .stat-card.total { border-left-color: #37474f; }
    .stat-card.r-type { border-left-color: #d32f2f; }
    .stat-card.ems-type { border-left-color: #1976d2; }
    .stat-card.cod-type { border-left-color: #ff9800; }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 8px;
        line-height: 1;
    }
    
    .stat-number.r-color { color: #d32f2f; }
    .stat-number.ems-color { color: #1976d2; }
    .stat-number.cod-color { color: #ff9800; }
    .stat-number.total-color { color: #37474f; }
    
    .stat-label {
        color: #666;
        font-weight: 600;
        font-size: 14px;
    }
    
    .chart-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .chart-title {
        text-align: center;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #37474f;
    }
    
    .detail-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px 0;
        overflow: hidden;
    }
    
    .detail-table-header {
        background: #37474f;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .detail-table-title {
        font-size: 18px;
        font-weight: 600;
    }
    
    .close-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.3s ease;
    }
    
    .close-btn:hover {
        background: #d32f2f;
    }
    
    .detail-table-wrapper {
        max-height: 500px;
        overflow: auto;
    }
    
    .detail-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .detail-table thead {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
    }
    
    .detail-table th {
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        border: 1px solid #ddd;
        background: #f8f9fa;
    }
    
    .detail-table td {
        padding: 10px;
        border: 1px solid #eee;
    }
    
    .detail-table tbody tr:hover {
        background: #f5f5f5;
    }
    
    .detail-table tbody tr:nth-child(even) {
        background: #fafafa;
    }
    
    .error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #c62828;
    }
</style>

<!-- Main Script -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    console.log('üìù [COMPONENT] ‡πÄ‡∏£‡∏¥‡πà‡∏° define ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    let currentTab = null;
    
    // =================================================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    // =================================================================
    
    window.loadWorkData = function(data) {
        console.log('üîÑ [loadWorkData] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', data);
        
        if (!data) {
            console.error('‚ùå [loadWorkData] ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!');
            return;
        }
        
        try {
            // ‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô
            document.getElementById('sendmoney-cod').textContent = data.sendMoney?.cod || 0;
            document.getElementById('total-sendmoney').textContent = data.sendMoney?.total || 0;
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°
            document.getElementById('prepare-r').textContent = data.prepare?.r || 0;
            document.getElementById('prepare-ems').textContent = data.prepare?.ems || 0;
            document.getElementById('prepare-cod').textContent = data.prepare?.cod || 0;
            document.getElementById('total-prepare').textContent = data.prepare?.total || 0;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            document.getElementById('recorded-r').textContent = data.recorded?.r || 0;
            document.getElementById('recorded-ems').textContent = data.recorded?.ems || 0;
            document.getElementById('recorded-cod').textContent = data.recorded?.cod || 0;
            document.getElementById('total-recorded').textContent = data.recorded?.total || 0;
            
            // ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
            document.getElementById('backlog-r').textContent = data.backlog?.r || 0;
            document.getElementById('backlog-ems').textContent = data.backlog?.ems || 0;
            document.getElementById('backlog-cod').textContent = data.backlog?.cod || 0;
            document.getElementById('total-backlog').textContent = data.backlog?.total || 0;
            
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
            document.getElementById('return-r').textContent = data.returned?.r || 0;
            document.getElementById('return-ems').textContent = data.returned?.ems || 0;
            document.getElementById('return-cod').textContent = data.returned?.cod || 0;
            document.getElementById('total-return').textContent = data.returned?.total || 0;
            
            console.log('‚úÖ [loadWorkData] ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } catch (error) {
            console.error('‚ùå [loadWorkData] Error:', error);
        }
    };
    
    // =================================================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Tab System
    // =================================================================
    
    window.showTab = function(tabType, workType) {
        console.log(`üîñ [showTab] ‡πÄ‡∏õ‡∏¥‡∏î Tab: ${tabType}, WorkType: ${workType}`);
        
        document.getElementById('tabsContainer').style.display = 'block';
        switchTab(tabType);
        
        // Scroll ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Tab
        setTimeout(() => {
            document.getElementById('tabsContainer').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    };
    
    window.switchTab = function(tabName) {
        console.log(`üîÑ [switchTab] ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ Tab: ${tabName}`);
        
        // Update Tab Active
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        currentTab = tabName;
        loadTabContent(tabName);
    };
    
    window.loadTabContent = function(tabName) {
    console.log(`üìä [loadTabContent] ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tab: ${tabName}`);
    
    const container = document.getElementById('tabContent');
    if (!container) {
        console.error('‚ùå [loadTabContent] ‡πÑ‡∏°‡πà‡∏û‡∏ö tabContent container');
        return;
    }
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ workData ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (typeof workData === 'undefined') {
        container.innerHTML = '<div class="error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• workData</div>';
        return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Tab
    let data;
    switch(tabName) {
        case 'sendMoney':
            data = workData.sendMoney;
            break;
            
        case 'prepare':
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á prepare ‡πÅ‡∏•‡∏∞ recorded
            data = {
                prepare: workData.prepare || { r: 0, ems: 0, cod: 0, total: 0 },
                recorded: workData.recorded || { r: 0, ems: 0, cod: 0, total: 0 }
            };
            break;
            
        case 'backlog':
            data = workData.backlog;
            break;
            
        case 'return':
            data = workData.returned;
            break;
            
        default:
            data = { r: 0, ems: 0, cod: 0, total: 0 };
    }
    
    displayTabContent(tabName, data);
};
    
 // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tab
function displayTabContent(tabName, data) {
    const container = document.getElementById('tabContent');
    
    // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: Tab "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
    if (tabName === 'prepare') {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° vs ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const prepare = data.prepare || { r: 0, ems: 0, cod: 0, total: 0 };
        const recorded = data.recorded || { r: 0, ems: 0, cod: 0, total: 0 };
        const notRecorded = {
            r: prepare.r - recorded.r,
            ems: prepare.ems - recorded.ems,
            cod: prepare.cod - recorded.cod,
            total: prepare.total - recorded.total
        };
        
        const html = `
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number total-color">${notRecorded.total || 0}</div>
                    <div class="stat-label">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                </div>
                <div class="stat-card r-type clickable" onclick="showDetailTable('prepare', 'R')">
                    <div class="stat-number r-color">${notRecorded.r || 0}</div>
                    <div class="stat-label">R</div>
                </div>
                <div class="stat-card ems-type clickable" onclick="showDetailTable('prepare', 'EMS')">
                    <div class="stat-number ems-color">${notRecorded.ems || 0}</div>
                    <div class="stat-label">EMS</div>
                </div>
                <div class="stat-card cod-type clickable" onclick="showDetailTable('prepare', 'COD')">
                    <div class="stat-number cod-color">${notRecorded.cod || 0}</div>
                    <div class="stat-label">COD</div>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-top: 0;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #e9ecef;">
                            <th style="padding: 10px; text-align: left;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th style="padding: 10px; text-align: center;">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</th>
                            <th style="padding: 10px; text-align: center;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</th>
                            <th style="padding: 10px; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px;">R</td>
                            <td style="padding: 10px; text-align: center;">${prepare.r}</td>
                            <td style="padding: 10px; text-align: center;">${recorded.r}</td>
                            <td style="padding: 10px; text-align: center; color: #d32f2f; font-weight: bold;">${notRecorded.r}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">EMS</td>
                            <td style="padding: 10px; text-align: center;">${prepare.ems}</td>
                            <td style="padding: 10px; text-align: center;">${recorded.ems}</td>
                            <td style="padding: 10px; text-align: center; color: #d32f2f; font-weight: bold;">${notRecorded.ems}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">COD</td>
                            <td style="padding: 10px; text-align: center;">${prepare.cod}</td>
                            <td style="padding: 10px; text-align: center;">${recorded.cod}</td>
                            <td style="padding: 10px; text-align: center; color: #d32f2f; font-weight: bold;">${notRecorded.cod}</td>
                        </tr>
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td style="padding: 10px;">‡∏£‡∏ß‡∏°</td>
                            <td style="padding: 10px; text-align: center;">${prepare.total}</td>
                            <td style="padding: 10px; text-align: center;">${recorded.total}</td>
                            <td style="padding: 10px; text-align: center; color: #d32f2f;">${notRecorded.total}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                <div id="pieChart" style="height: 300px;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; color: #666;">
                <p>üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç R, EMS ‡∏´‡∏£‡∏∑‡∏≠ COD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
            </div>
        `;
        
        container.innerHTML = html;
        
        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
        if (notRecorded.total > 0) {
            drawPieChart('pieChart', [
                ['R', notRecorded.r || 0],
                ['EMS', notRecorded.ems || 0],
                ['COD', notRecorded.cod || 0]
            ]);
        } else {
            document.getElementById('pieChart').innerHTML = 
                '<div style="text-align: center; padding: 40px; color: #4caf50; font-size: 18px;">üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!</div>';
        }
        
        return;
    }
    
    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: Tab ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (sendMoney, backlog, return)
    const html = `
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number total-color">${data.total || 0}</div>
                <div class="stat-label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="stat-card r-type clickable" onclick="showDetailTable('${tabName}', 'R')">
                <div class="stat-number r-color">${data.r || 0}</div>
                <div class="stat-label">R</div>
            </div>
            <div class="stat-card ems-type clickable" onclick="showDetailTable('${tabName}', 'EMS')">
                <div class="stat-number ems-color">${data.ems || 0}</div>
                <div class="stat-label">EMS</div>
            </div>
            <div class="stat-card cod-type clickable" onclick="showDetailTable('${tabName}', 'COD')">
                <div class="stat-number cod-color">${data.cod || 0}</div>
                <div class="stat-label">COD</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</div>
            <div id="pieChart" style="height: 300px;"></div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; color: #666;">
            <p>üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç R, EMS ‡∏´‡∏£‡∏∑‡∏≠ COD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
        </div>
    `;
    
    container.innerHTML = html;
    
    // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    drawPieChart('pieChart', [
        ['R', data.r || 0],
        ['EMS', data.ems || 0],
        ['COD', data.cod || 0]
    ]);
}
    // =================================================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    // =================================================================
// ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function showDetailTable(tabType, workType) {
    const container = document.getElementById('tabContent');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</p></div>';
    
    // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: Tab "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    if (tabType === 'prepare') {
        console.log('üìã [showDetailTable] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        
        google.script.run
            .withSuccessHandler((result) => {
                if (result.status === 'success') {
                    displayDetailTable(result.headers, result.data, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                } else {
                    container.innerHTML = `<div class="error-message">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message}</div>`;
                }
            })
            .withFailureHandler((error) => {
                container.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
            })
            .getNotRecordedData(currentUser.username);
        
        return;
    }
    
    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: Tab ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (backlog, return, sendMoney)
    const dataType = tabType === 'backlog' ? 'backlog' : 
                     tabType === 'return' ? 'return' : 'sendMoney';
    
    console.log(`üìã [showDetailTable] Type: ${dataType}, WorkType: ${workType}`);
    
    google.script.run
        .withSuccessHandler((result) => {
            if (result.status === 'success') {
                displayDetailTable(result.headers, result.data, `${workType} - ${getTabName(tabType)}`);
            } else {
                container.innerHTML = `<div class="error-message">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message}</div>`;
            }
        })
        .withFailureHandler((error) => {
            container.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
        })
        .getDetailWorkData(dataType, workType, currentUser.username);
}

// Helper: ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ Tab
function getTabName(tabType) {
    const names = {
        'sendMoney': '‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô',
        'prepare': '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        'backlog': '‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á',
        'return': '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô'
    };
    return names[tabType] || tabType;
}
    // =================================================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    // =================================================================
    
    window.drawPieChart = function(containerId, data) {
        console.log(`üìä [drawPieChart] ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô: ${containerId}`, data);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const hasData = data.some(item => item[1] > 0);
        
        if (!hasData) {
            document.getElementById(containerId).innerHTML = 
                '<div style="text-align: center; padding: 60px; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü</div>';
            return;
        }
        
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function() {
            try {
                const chartData = google.visualization.arrayToDataTable([
                    ['Type', 'Count'],
                    ...data
                ]);
                
                const options = {
                    pieHole: 0.4,
                    colors: ['#d32f2f', '#1976d2', '#ff9800'],
                    legend: { position: 'bottom' },
                    backgroundColor: 'transparent',
                    chartArea: { width: '90%', height: '80%' }
                };
                
                const chart = new google.visualization.PieChart(
                    document.getElementById(containerId)
                );
                
                chart.draw(chartData, options);
                console.log('‚úÖ [drawPieChart] ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('‚ùå [drawPieChart] Error:', error);
            }
        });
    };
    
    // =================================================================
    // Auto-Load ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // =================================================================
    
    console.log('‚úÖ [COMPONENT] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å define ‡πÅ‡∏•‡πâ‡∏ß');
    
    // ‡∏£‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    (function() {
        const initComponent = function() {
            console.log('üîç [COMPONENT] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            console.log('   - workData:', typeof workData !== 'undefined' ? '‡∏°‡∏µ' : '‡πÑ‡∏°‡πà‡∏°‡∏µ');
            console.log('   - currentUser:', typeof currentUser !== 'undefined' ? '‡∏°‡∏µ' : '‡πÑ‡∏°‡πà‡∏°‡∏µ');
            
            if (typeof workData !== 'undefined' && workData) {
                console.log('‚úÖ [COMPONENT] ‡∏û‡∏ö workData, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                loadWorkData(workData);
            } else {
                console.warn('‚ö†Ô∏è [COMPONENT] ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö workData, ‡∏£‡∏≠ 500ms...');
                
                setTimeout(() => {
                    if (typeof workData !== 'undefined' && workData) {
                        console.log('‚úÖ [COMPONENT] ‡∏û‡∏ö workData ‡πÅ‡∏•‡πâ‡∏ß, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                        loadWorkData(workData);
                    } else {
                        console.error('‚ùå [COMPONENT] ‡πÑ‡∏°‡πà‡∏û‡∏ö workData ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏≠ 500ms');
                    }
                }, 500);
            }
        };
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initComponent);
        } else {
            initComponent();
        }
    })();
    function displayDetailTable(headers, data, title) {
    const container = document.getElementById('tabContent');
    
    if (!data || data.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #999;">
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${title}
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="detail-table-container">
            <div class="detail-table-header">
                <div class="detail-table-title">${title} (${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
                <button class="close-btn" onclick="loadTabContent(currentTab)">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>
            <div class="detail-table-wrapper">
                <table class="detail-table">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                ${row.map(cell => `<td>${cell || '-'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}
    /**
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Horizontal Scroll)
 * 
 * @param {Array} headers - ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î', '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', ...]
 * @param {Array} data - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2D Array ‡πÄ‡∏ä‡πà‡∏ô [['2025-01-10', 'R123456', 'john'], ...]
 * @param {string} title - ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô "R - ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á"
 */
window.displayDetailTable = function(headers, data, title) {
    console.log(`üìä [displayDetailTable] ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ${title}`);
    console.log(`üìä [displayDetailTable] ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${headers.length}`);
    console.log(`üìä [displayDetailTable] ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß: ${data.length}`);
    
    const container = document.getElementById('tabContent');
    
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (!data || data.length === 0) {
        container.innerHTML = `
            <div style="
                text-align: center;
                padding: 60px 20px;
                background: #f8f9fa;
                border-radius: 12px;
                border: 2px dashed #ddd;
            ">
                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                <h3 style="color: #666; margin: 0 0 10px 0;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${title}</h3>
                <p style="color: #999; font-size: 14px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á</p>
                <button onclick="loadTabContent(currentTab)" style="
                    margin-top: 20px;
                    padding: 10px 20px;
                    background: #1976d2;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                ">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü</button>
            </div>
        `;
        return;
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const html = `
        <div class="detail-table-container">
            <!-- Header -->
            <div class="detail-table-header">
                <div class="detail-table-title">
                    üìã ${title} <span style="opacity: 0.8; font-size: 14px;">(${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                </div>
                <button class="close-btn" onclick="loadTabContent(currentTab)">
                    ‚úï ‡∏õ‡∏¥‡∏î
                </button>
            </div>
            
            <!-- Scroll Hint -->
            <div style="
                background: #e3f2fd;
                padding: 10px 20px;
                border-bottom: 1px solid #90caf9;
                text-align: center;
                font-size: 13px;
                color: #1565c0;
            ">
                üí° <strong>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </div>
            
            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Horizontal Scroll) -->
            <div class="detail-table-wrapper">
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th style="
                                position: sticky;
                                left: 0;
                                background: #37474f;
                                color: white;
                                z-index: 20;
                                min-width: 50px;
                                text-align: center;
                            ">#</th>
                            ${headers.map((header, index) => `
                                <th style="
                                    min-width: ${getColumnWidth(header, index)}px;
                                    white-space: nowrap;
                                ">${header}</th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map((row, rowIndex) => `
                            <tr>
                                <td style="
                                    position: sticky;
                                    left: 0;
                                    background: ${rowIndex % 2 === 0 ? '#fafafa' : 'white'};
                                    font-weight: 600;
                                    color: #666;
                                    z-index: 10;
                                    text-align: center;
                                    border-right: 2px solid #ddd;
                                ">${rowIndex + 1}</td>
                                ${row.map((cell, cellIndex) => `
                                    <td style="
                                        white-space: nowrap;
                                        max-width: 300px;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                    " title="${escapeHtml(cell)}">${formatCell(cell, headers[cellIndex])}</td>
                                `).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div style="
                background: #f8f9fa;
                padding: 15px 20px;
                border-top: 2px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div style="font-size: 14px; color: #666;">
                    üìä ‡πÅ‡∏™‡∏î‡∏á <strong>${data.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>
                <button onclick="exportTableToCSV('${title}')" style="
                    padding: 8px 16px;
                    background: #4caf50;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                ">üì• Export CSV</button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    console.log('‚úÖ [displayDetailTable] ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
};

/**
 * ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
 */
function getColumnWidth(headerName, index) {
    const widthMap = {
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': 120,
        'Date': 120,
        '‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î': 150,
        'Barcode': 150,
        'Tracking': 150,
        '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 150,
        'Operator': 150,
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': 150,
        'Status': 150,
        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': 200,
        'Remark': 200,
        'Note': 200
    };
    
    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠ default 100px
    return widthMap[headerName] || 100;
}

/**
 * Format ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function formatCell(value, headerName) {
    if (!value && value !== 0) return '-';
    
    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    if (headerName && (headerName.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || headerName.includes('Date'))) {
        try {
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        } catch (e) {
            // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        }
    }
    
    // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    if (typeof value === 'number') {
        return value.toLocaleString('th-TH');
    }
    
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ
    if (headerName && headerName.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞')) {
        const status = value.toString().trim();
        let color = '#666';
        let bgColor = '#f5f5f5';
        
        if (status.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') || status.includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß')) {
            color = '#2e7d32';
            bgColor = '#e8f5e9';
        } else if (status.includes('‡∏£‡∏≠') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) {
            color = '#f57c00';
            bgColor = '#fff3e0';
        } else if (status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status.includes('‡πÑ‡∏°‡πà')) {
            color = '#c62828';
            bgColor = '#ffebee';
        }
        
        return `<span style="
            display: inline-block;
            padding: 4px 12px;
            background: ${bgColor};
            color: ${color};
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        ">${value}</span>`;
    }
    
    return escapeHtml(value);
}

/**
 * Escape HTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS
 */
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
}

/**
 * Export ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô CSV
 */
function exportTableToCSV(filename) {
    console.log('üì• [exportTableToCSV] ‡∏Å‡∏≥‡∏•‡∏±‡∏á Export:', filename);
    
    const table = document.querySelector('.detail-table');
    if (!table) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        return;
    }
    
    let csv = [];
    
    // Headers
    const headers = [];
    table.querySelectorAll('thead th').forEach((th, index) => {
        if (index > 0) { // ‡∏Ç‡πâ‡∏≤‡∏° # column
            headers.push(th.textContent.trim());
        }
    });
    csv.push(headers.join(','));
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach((td, index) => {
            if (index > 0) { // ‡∏Ç‡πâ‡∏≤‡∏° # column
                let value = td.textContent.trim();
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ comma ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà double quotes
                if (value.includes(',')) {
                    value = `"${value}"`;
                }
                row.push(value);
            }
        });
        csv.push(row.join(','));
    });
    
    // Download
    const csvContent = '\uFEFF' + csv.join('\n'); // \uFEFF = BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UTF-8
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}_${new Date().getTime()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('‚úÖ [exportTableToCSV] Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}
    console.log('üéâ [COMPONENT] DashboardComponent.html ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
</script>
