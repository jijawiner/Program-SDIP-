<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á My Work Overview -->
<div class="work-table-container">
    <table class="work-overview-table">
        <thead>
            <tr>
                <th></th>
                <th>‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</th>
                <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                <th>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</th>
                <th>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="work-type-label">R</td>
                <td class="work-value">-</td>
                <td class="work-value" id="prepare-r">-</td>
                <td class="work-value" id="recorded-r">-</td>
                <td class="work-value clickable" onclick="showTab('backlog', 'R')" id="backlog-r">-</td>
                <td class="work-value clickable" onclick="showTab('return', 'R')" id="return-r">-</td>
            </tr>
            <tr>
                <td class="work-type-label">EMS</td>
                <td class="work-value">-</td>
                <td class="work-value" id="prepare-ems">-</td>
                <td class="work-value" id="recorded-ems">-</td>
                <td class="work-value clickable" onclick="showTab('backlog', 'EMS')" id="backlog-ems">-</td>
                <td class="work-value clickable" onclick="showTab('return', 'EMS')" id="return-ems">-</td>
            </tr>
            <tr>
                <td class="work-type-label">COD</td>
                <td class="work-value clickable" onclick="showTab('sendMoney', 'COD')" id="sendmoney-cod">-</td>
                <td class="work-value" id="prepare-cod">-</td>
                <td class="work-value" id="recorded-cod">-</td>
                <td class="work-value clickable" onclick="showTab('backlog', 'COD')" id="backlog-cod">-</td>
                <td class="work-value clickable" onclick="showTab('return', 'COD')" id="return-cod">-</td>
            </tr>
            <tr class="total-row">
                <td class="work-type-label">üì¶ ‡∏£‡∏ß‡∏°</td>
                <td class="work-total" id="total-sendmoney">-</td>
                <td class="work-total" id="total-prepare">-</td>
                <td class="work-total" id="total-recorded">-</td>
                <td class="work-total" id="total-backlog">-</td>
                <td class="work-total" id="total-return">-</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 4 Tabs -->
<div id="tabsContainer" style="display: none; margin-top: 30px;">
    <div class="tabs-header">
        <div class="tab" data-tab="sendMoney" onclick="switchTab('sendMoney')">‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div class="tab" data-tab="prepare" onclick="switchTab('prepare')">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div class="tab" data-tab="backlog" onclick="switchTab('backlog')">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</div>
        <div class="tab" data-tab="return" onclick="switchTab('return')">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</div>
    </div>
    
    <div class="tabs-content">
        <!-- Tab Content ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        <div id="tabContent"></div>
    </div>
</div>

<style>
    .work-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .work-overview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 16px;
    }
    
    .work-overview-table thead {
        background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
        color: white;
    }
    
    .work-overview-table th {
        padding: 15px;
        text-align: center;
        font-weight: 600;
    }
    
    .work-overview-table td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .work-type-label {
        font-weight: 700;
        color: #333;
        text-align: left !important;
        padding-left: 30px !important;
    }
    
    .work-value {
        font-size: 18px;
        font-weight: 600;
        color: #666;
    }
    
    .work-value.clickable {
        color: #1976d2;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .work-value.clickable:hover {
        color: #d32f2f;
        transform: scale(1.1);
    }
    
    .total-row {
        background: #f8f9fa;
        border-top: 2px solid #37474f;
    }
    
    .work-total {
        font-size: 20px;
        font-weight: 700;
        color: #d32f2f;
    }
    
    .tabs-header {
        display: flex;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
        overflow: hidden;
    }
    
    .tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
    }
    
    .tab:hover {
        background: #e9ecef;
    }
    
    .tab.active {
        background: white;
        color: #d32f2f;
        border-bottom-color: #d32f2f;
    }
    
    .tabs-content {
        background: white;
        padding: 30px;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 400px;
    }
</style>

<script>
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function loadWorkData(data) {
        console.log('üîÑ [loadWorkData] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', data);
        
        // ‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô
        document.getElementById('sendmoney-cod').textContent = data.sendMoney.cod || 0;
        document.getElementById('total-sendmoney').textContent = data.sendMoney.total || 0;
        
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°
        document.getElementById('prepare-r').textContent = data.prepare.r || 0;
        document.getElementById('prepare-ems').textContent = data.prepare.ems || 0;
        document.getElementById('prepare-cod').textContent = data.prepare.cod || 0;
        document.getElementById('total-prepare').textContent = data.prepare.total || 0;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        document.getElementById('recorded-r').textContent = data.recorded.r || 0;
        document.getElementById('recorded-ems').textContent = data.recorded.ems || 0;
        document.getElementById('recorded-cod').textContent = data.recorded.cod || 0;
        document.getElementById('total-recorded').textContent = data.recorded.total || 0;
        
        // ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
        document.getElementById('backlog-r').textContent = data.backlog.r || 0;
        document.getElementById('backlog-ems').textContent = data.backlog.ems || 0;
        document.getElementById('backlog-cod').textContent = data.backlog.cod || 0;
        document.getElementById('total-backlog').textContent = data.backlog.total || 0;
        
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
        document.getElementById('return-r').textContent = data.returned.r || 0;
        document.getElementById('return-ems').textContent = data.returned.ems || 0;
        document.getElementById('return-cod').textContent = data.returned.cod || 0;
        document.getElementById('total-return').textContent = data.returned.total || 0;
        
        console.log('‚úÖ [loadWorkData] ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
    
    // ‚≠ê Auto-load ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    (function() {
        console.log('üîç [DashboardComponent] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        
        // ‡∏£‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                tryLoadData();
            });
        } else {
            tryLoadData();
        }
        
        function tryLoadData() {
            if (typeof workData !== 'undefined' && workData) {
                console.log('‚úÖ [DashboardComponent] ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• workData');
                loadWorkData(workData);
            } else {
                console.warn('‚ö†Ô∏è [DashboardComponent] ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• workData');
            }
        }
    })();
    
    // ‡πÅ‡∏™‡∏î‡∏á Tab
    function showTab(tabType, workType) {
        document.getElementById('tabsContainer').style.display = 'block';
        switchTab(tabType);
        
        // Scroll ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Tab
        document.getElementById('tabsContainer').scrollIntoView({ behavior: 'smooth' });
    }
    
    // ‡∏™‡∏•‡∏±‡∏ö Tab
    let currentTab = null;
    
    function switchTab(tabName) {
        // Update Tab Active
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        currentTab = tabName;
        loadTabContent(tabName);
    }
    
    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tab
    function loadTabContent(tabName) {
        const container = document.getElementById('tabContent');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>';
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Tab
        let data;
        switch(tabName) {
            case 'sendMoney':
                data = workData.sendMoney;
                break;
            case 'prepare':
                data = {
                    prepare: workData.prepare,
                    recorded: workData.recorded
                };
                break;
            case 'backlog':
                data = workData.backlog;
                break;
            case 'return':
                data = workData.returned;
                break;
        }
        
        displayTabContent(tabName, data);
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tab
    function displayTabContent(tabName, data) {
        const container = document.getElementById('tabContent');
        
        const html = `
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number total-color">${data.total || 0}</div>
                    <div class="stat-label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card r-type clickable" onclick="showDetailTable('${tabName}', 'R')">
                    <div class="stat-number r-color">${data.r || 0}</div>
                    <div class="stat-label">R</div>
                </div>
                <div class="stat-card ems-type clickable" onclick="showDetailTable('${tabName}', 'EMS')">
                    <div class="stat-number ems-color">${data.ems || 0}</div>
                    <div class="stat-label">EMS</div>
                </div>
                <div class="stat-card cod-type clickable" onclick="showDetailTable('${tabName}', 'COD')">
                    <div class="stat-number cod-color">${data.cod || 0}</div>
                    <div class="stat-label">COD</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</div>
                <div id="pieChart" style="height: 300px;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; color: #666;">
                <p>üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç R, EMS ‡∏´‡∏£‡∏∑‡∏≠ COD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
            </div>
        `;
        
        container.innerHTML = html;
        
        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
        drawPieChart('pieChart', [
            ['R', data.r || 0],
            ['EMS', data.ems || 0],
            ['COD', data.cod || 0]
        ]);
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    function showDetailTable(tabType, workType) {
        const container = document.getElementById('tabContent');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</p></div>';
        
        const dataType = tabType === 'backlog' ? 'backlog' : 'return';
        
        google.script.run
            .withSuccessHandler(displayDetailTable)
            .withFailureHandler(error => {
                container.innerHTML = `<div class="error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            })
            .getDetailWorkData(dataType, workType, currentUser.username);
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    function displayDetailTable(result) {
        const container = document.getElementById('tabContent');
        
        if (!result.data || result.data.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            return;
        }
        
        const headerHtml = result.headers.map(h => `<th>${h}</th>`).join('');
        const rowsHtml = result.data.map(row => {
            const cellsHtml = row.map(cell => `<td>${cell || '-'}</td>`).join('');
            return `<tr>${cellsHtml}</tr>`;
        }).join('');
        
        container.innerHTML = `
            <div class="detail-table-container">
                <div class="detail-table-header">
                    <div class="detail-table-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${result.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
                    <button class="close-btn" onclick="loadTabContent(currentTab)">‡∏õ‡∏¥‡∏î</button>
                </div>
                <div class="detail-table-wrapper">
                    <table class="detail-table">
                        <thead><tr>${headerHtml}</tr></thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°
    function drawPieChart(containerId, data) {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => {
            const chartData = google.visualization.arrayToDataTable([
                ['Type', 'Count'],
                ...data
            ]);
            
            const options = {
                pieHole: 0.4,
                colors: ['#d32f2f', '#1976d2', '#f57c00'],
                legend: { position: 'bottom' },
                backgroundColor: 'transparent'
            };
            
            const chart = new google.visualization.PieChart(document.getElementById(containerId));
            chart.draw(chartData, options);
        });
    }
</script>
